This article describes the essential changes for projects to migrate from Apollo R\-O\-S(3.\-0 and before) to Apollo Cyber-\/\-R\-T(3.\-5). We will be using the very first R\-O\-S project talker/listener as example to demostrate step by step migration instruction.

\subsection*{Build system}

R\-O\-S use {\ttfamily C\-Make} as its build system but Cyber-\/\-R\-T use {\ttfamily bazel}. In a R\-O\-S project, Cmake\-Lists.\-txt and package.\-xml are required for defining build configs like build target, dependency, message files and so on. As for a Cyber-\/\-R\-T component, a single bazel B\-U\-I\-L\-D file covers. Some key build config mappings are listed below.

Cmake

``` project(pb\-\_\-msgs\-\_\-example) add\-\_\-proto\-\_\-files( D\-I\-R\-E\-C\-T\-O\-R\-Y proto F\-I\-L\-E\-S chatter.\-proto ) \subsection*{Declare a C++ executable}

add\-\_\-executable(pb\-\_\-talker src/talker.\-cpp) target\-\_\-link\-\_\-libraries(pb\-\_\-talker \$\{catkin\-\_\-\-L\-I\-B\-R\-A\-R\-I\-E\-S\}pb\-\_\-msgs\-\_\-example\-\_\-proto) add\-\_\-executable(pb\-\_\-listener src/listener.\-cpp) target\-\_\-link\-\_\-libraries(pb\-\_\-listener \$\{catkin\-\_\-\-L\-I\-B\-R\-A\-R\-I\-E\-S\} pb\-\_\-msgs\-\_\-example\-\_\-proto) ```

Bazel

``` cc\-\_\-binary( name = \char`\"{}talker\char`\"{}, srcs = \mbox{[}\char`\"{}talker.\-cc\char`\"{}\mbox{]}, deps = \mbox{[} \char`\"{}//cyber\char`\"{}, \char`\"{}//cyber/examples/proto\-:examples\-\_\-cc\-\_\-proto\char`\"{}, \mbox{]}, ) cc\-\_\-binary( name = \char`\"{}listener\char`\"{}, srcs = \mbox{[}\char`\"{}listener.\-cc\char`\"{}\mbox{]}, deps = \mbox{[} \char`\"{}//cyber\char`\"{}, \char`\"{}//cyber/examples/proto\-:examples\-\_\-cc\-\_\-proto\char`\"{}, \mbox{]}, ) ``{\ttfamily  We can find the mapping easily from the 2 file snippets. For example,}pb\-\_\-talker{\ttfamily and}src/talker.\-cpp{\ttfamily in cmake}add\-\_\-executable{\ttfamily setting map to}name = \char`\"{}talker\char`\"{}{\ttfamily and}srcs = \mbox{[}\char`\"{}talker.\-cc\char`\"{}\mbox{]}{\ttfamily in B\-U\-I\-L\-D file}cc\-\_\-binary`. \subsubsection*{Proto}

Apollo R\-O\-S has customized to support proto message formate that a separate section {\ttfamily add\-\_\-proto\-\_\-files} and project\-Name\-\_\-proto({\ttfamily pb\-\_\-msgs\-\_\-example\-\_\-proto}) in {\ttfamily target\-\_\-link\-\_\-libraries} are required to send message in proto formate. For config proto message in Cyber-\/\-R\-T, it's as simple as adding the target proto file path concantenated with name of {\ttfamily cc\-\_\-proto\-\_\-library} in {\ttfamily deps} setting. The {\ttfamily cc\-\_\-proto\-\_\-library} is set up in B\-U\-I\-L\-D file under proto folder.

```\-C cc\-\_\-proto\-\_\-library( name = \char`\"{}examples\-\_\-cc\-\_\-proto\char`\"{}, deps = \mbox{[} \char`\"{}\-:examples\-\_\-proto\char`\"{}, \mbox{]}, ) proto\-\_\-library( name = \char`\"{}examples\-\_\-proto\char`\"{}, srcs = \mbox{[} \char`\"{}examples.\-proto\char`\"{}, \mbox{]}, ) ```

The package definition has also changed in Cyber-\/\-R\-T. In Apollo R\-O\-S a fixed package {\ttfamily package pb\-\_\-msgs;} is used for proto files, but in Cyber-\/\-R\-T, the proto file path {\ttfamily package apollo.\-cyber.\-examples.\-proto;} is used instead.

\subsection*{Folder structure}

As shown below, Cyber-\/\-R\-T remove the src folder and pull all source code in the same folder as B\-U\-I\-L\-D file. B\-U\-I\-L\-D file plays the same role as C\-Make\-Lists.\-txt plus package.\-xml. Both Cyber-\/\-R\-T and Apollo R\-O\-S talker/listener example have a proto folder for message proto files but Cyber-\/\-R\-T requires a separate B\-U\-I\-L\-D file for proto folder to set up the proto library.

\subsubsection*{Apollo R\-O\-S}


\begin{DoxyItemize}
\item C\-Make\-Lists.\-txt
\item package.\-xml
\item proto
\begin{DoxyItemize}
\item chatter.\-proto
\end{DoxyItemize}
\item src
\begin{DoxyItemize}
\item listener.\-cpp
\item talker.\-cpp
\end{DoxyItemize}
\end{DoxyItemize}

\subsubsection*{Cyber-\/\-R\-T}


\begin{DoxyItemize}
\item B\-U\-I\-L\-D
\item listener.\-ccc
\item talker.\-cc
\item proto
\begin{DoxyItemize}
\item B\-U\-I\-L\-D
\item examples.\-proto (with chatter message)
\end{DoxyItemize}
\end{DoxyItemize}

\subsection*{Update source code}

\subsubsection*{Listener}

Cyber-\/\-R\-T

```c \#include \char`\"{}cyber/cyber.\-h\char`\"{} \#include \char`\"{}cyber/examples/proto/examples.\-pb.\-h\char`\"{}

void Message\-Callback( const std\-::shared\-\_\-ptr$<$apollo\-::cyber\-::examples\-::proto\-::\-Chatter$>$\& msg) \{ A\-I\-N\-F\-O $<$$<$ \char`\"{}\-Received message seq-\/$>$ \char`\"{} $<$$<$ msg-\/$>$seq(); A\-I\-N\-F\-O $<$$<$ \char`\"{}msgcontent-\/$>$\char`\"{} $<$$<$ msg-\/$>$content(); \}

int main(int argc, char$\ast$ argv\mbox{[}$\,$\mbox{]}) \{ // init cyber framework apollo\-::cyber\-::\-Init(argv\mbox{[}0\mbox{]}); // create listener node auto listener\-\_\-node = \hyperlink{namespaceapollo_1_1cyber_ae369c5de0279f2a5745d0438d532bc89}{apollo\-::cyber\-::\-Create\-Node}(\char`\"{}listener\char`\"{}); // create listener auto listener = listener\-\_\-node-\/$>$Create\-Reader$<$apollo\-::cyber\-::examples\-::proto\-::\-Chatter$>$( \char`\"{}channel/chatter\char`\"{}, Message\-Callback); \hyperlink{namespaceapollo_1_1cyber_a7929114e78a9c595b0ee715968ca2712}{apollo\-::cyber\-::\-Wait\-For\-Shutdown()}; return 0; \} ``` R\-O\-S

```c \#include \char`\"{}ros/ros.\-h\char`\"{} \#include \char`\"{}chatter.\-pb.\-h\char`\"{}

void Message\-Callback(const boost\-::shared\-\_\-ptr$<$pb\-\_\-msgs\-::\-Chatter$>$\& msg) \{ R\-O\-S\-\_\-\-I\-N\-F\-O\-\_\-\-S\-T\-R\-E\-A\-M(\char`\"{}\-Time\-: \char`\"{} $<$$<$ msg-\/$>$stamp().sec() $<$$<$ \char`\"{}.\char`\"{} $<$$<$ msg-\/$>$stamp().nsec()); R\-O\-S\-\_\-\-I\-N\-F\-O(\char`\"{}\-I heard pb Chatter message\-: \mbox{[}\%s\mbox{]}\char`\"{}, msg-\/$>$content().c\-\_\-str()); \}

int main(int argc, char$\ast$$\ast$ argv) \{ ros\-::init(argc, argv, \char`\"{}listener\char`\"{}); ros\-::\-Node\-Handle n; ros\-::\-Subscriber pb\-\_\-sub = n.\-subscribe(\char`\"{}chatter\char`\"{}, 1000, Message\-Callback); ros\-::spin(); return 0; \} ```

You can see easily from the two listener code above that Cyber-\/\-R\-T provides very similar A\-P\-I to for developers to migrate from R\-O\-S.


\begin{DoxyItemize}
\item {\ttfamily ros\-::init(argc, argv, \char`\"{}listener\char`\"{});} --$>$ {\ttfamily apollo\-::cyber\-::\-Init(argv\mbox{[}0\mbox{]});}
\item {\ttfamily ros\-::\-Node\-Handle n;} --$>$ {\ttfamily auto listener\-\_\-node = \hyperlink{namespaceapollo_1_1cyber_ae369c5de0279f2a5745d0438d532bc89}{apollo\-::cyber\-::\-Create\-Node}(\char`\"{}listener\char`\"{});}
\item {\ttfamily ros\-::\-Subscriber pb\-\_\-sub = n.\-subscribe(\char`\"{}chatter\char`\"{}, 1000, Message\-Callback);} --$>$ {\ttfamily auto listener = listener\-\_\-node-\/$>$Create\-Reader(\char`\"{}channel/chatter\char`\"{}, Message\-Callback);}
\item {\ttfamily ros\-::spin();} --$>$ {\ttfamily \hyperlink{namespaceapollo_1_1cyber_a7929114e78a9c595b0ee715968ca2712}{apollo\-::cyber\-::\-Wait\-For\-Shutdown()};}
\end{DoxyItemize}

Note\-: for Cyber-\/\-R\-T, a listener node has to use {\ttfamily node-\/$>$Create\-Reader$<$message\-Type$>$(channel\-Name, callback)} to read data from channel.

\subsubsection*{Talker}

Cyber-\/\-R\-T

```\-C \#include \char`\"{}cyber/cyber.\-h\char`\"{} \#include \char`\"{}cyber/examples/proto/examples.\-pb.\-h\char`\"{}

using apollo\-::cyber\-::examples\-::proto\-::\-Chatter;

int main(int argc, char $\ast$argv\mbox{[}$\,$\mbox{]}) \{ // init cyber framework apollo\-::cyber\-::\-Init(argv\mbox{[}0\mbox{]}); // create talker node auto talker\-\_\-node = \hyperlink{namespaceapollo_1_1cyber_ae369c5de0279f2a5745d0438d532bc89}{apollo\-::cyber\-::\-Create\-Node}(\char`\"{}talker\char`\"{}); // create talker auto talker = talker\-\_\-node-\/$>$Create\-Writer$<$\-Chatter$>$(\char`\"{}channel/chatter\char`\"{}); Rate rate(1.\-0); while (\hyperlink{namespaceapollo_1_1cyber_aafa5f9962b51918897897bbc0fdd802f}{apollo\-::cyber\-::\-O\-K()}) \{ static uint64\-\_\-t seq = 0; auto msg = std\-::make\-\_\-shared$<$\-Chatter$>$(); msg-\/$>$set\-\_\-timestamp(Time\-::\-Now().To\-Nanosecond()); msg-\/$>$set\-\_\-lidar\-\_\-timestamp(Time\-::\-Now().To\-Nanosecond()); msg-\/$>$set\-\_\-seq(seq++); msg-\/$>$set\-\_\-content(\char`\"{}\-Hello, apollo!\char`\"{}); talker-\/$>$Write(msg); A\-I\-N\-F\-O $<$$<$ \char`\"{}talker sent a message!\char`\"{}; rate.\-Sleep(); \} return 0; \} ```

R\-O\-S

```c \#include \char`\"{}ros/ros.\-h\char`\"{} \#include \char`\"{}chatter.\-pb.\-h\char`\"{}

\#include $<$sstream$>$

int main(int argc, char$\ast$$\ast$ argv) \{ ros\-::init(argc, argv, \char`\"{}talker\char`\"{}); ros\-::\-Node\-Handle n; ros\-::\-Publisher chatter\-\_\-pub = n.\-advertise$<$pb\-\_\-msgs\-::\-Chatter$>$(\char`\"{}chatter\char`\"{}, 1000); ros\-::\-Rate loop\-\_\-rate(10); int count = 0; while (ros\-::ok()) \{ pb\-\_\-msgs\-::\-Chatter msg; ros\-::\-Time now = ros\-::\-Time\-::now(); msg.\-mutable\-\_\-stamp()-\/$>$set\-\_\-sec(now.\-sec); msg.\-mutable\-\_\-stamp()-\/$>$set\-\_\-nsec(now.\-nsec); std\-::stringstream ss; ss $<$$<$ \char`\"{}\-Hello world \char`\"{} $<$$<$ count; msg.\-set\-\_\-content(ss.\-str()); chatter\-\_\-pub.\-publish(msg); ros\-::spin\-Once(); loop\-\_\-rate.\-sleep(); \} return 0; \} ``` Most of the mappings are illustrated in listener code above, the rest are listed here.


\begin{DoxyItemize}
\item {\ttfamily ros\-::\-Publisher chatter\-\_\-pub = n.\-advertise$<$pb\-\_\-msgs\-::\-Chatter$>$(\char`\"{}chatter\char`\"{}, 1000);} --$>$ {\ttfamily auto talker = talker\-\_\-node-\/$>$Create\-Writer$<$Chatter$>$(\char`\"{}channel/chatter\char`\"{});}
\item {\ttfamily chatter\-\_\-pub.\-publish(msg);} --$>$ {\ttfamily talker-\/$>$Write(msg);}
\end{DoxyItemize}

\subsection*{Tools mapping}

\begin{TabularC}{3}
\hline
\rowcolor{lightgray}{\bf R\-O\-S }&{\bf Cyber-\/\-R\-T }&{\bf Note  }\\\cline{1-3}
rosbag &cyber\-\_\-recorder &data file \\\cline{1-3}
scripts/diagnostics.\-sh &cyber\-\_\-monitor &channel debug \\\cline{1-3}
offline\-\_\-lidar\-\_\-visualizer\-\_\-tool &cyber\-\_\-visualizer &point cloud visualizer \\\cline{1-3}
\end{TabularC}
\subsection*{R\-O\-S bag data migration}

The data file changed from R\-O\-S bag to Cyber record in Cyber-\/\-R\-T. Cyber-\/\-R\-T has a data migration tool {\ttfamily rosbag\-\_\-to\-\_\-record} for users to easily migrate data files before Apollo 3.\-0 (R\-O\-S) to Cyber-\/\-R\-T like the sample usage below.

```bash rosbag\-\_\-to\-\_\-record demo\-\_\-3.\-0.\-bag demo\-\_\-3.\-5.\-record ``` 